
<ion-header [translucent]="true">
	<ion-toolbar>
		<ion-buttons slot="start">
			<ion-menu-button></ion-menu-button>
		</ion-buttons>
		<ion-title slot="start">
			<div class="flex aic">
				<ion-icon *ngIf="entityConfig.sidebarConfig?.icon" [name]="entityConfig.sidebarConfig?.icon" style="margin-inline-end: 5px;"></ion-icon>
				{{ entityConfig.contentType | translate }}
			</div>
		</ion-title>
		<ion-buttons slot="start">
			<mika-lang-switcher [config]="entityConfig"/>
		</ion-buttons>
		<ion-buttons slot="end">
			<ion-button (click)="toggleBulkMode()" [color]="bulkMode ? 'warning' : 'primary'">
				<ion-icon slot="icon-only" [name]="bulkMode ? 'create' : 'create-outline'"></ion-icon>
			</ion-button>

			@if (entityConfig.table.filters && entityConfig.table.filters.length || entityConfig.actions.items?.search) {
				<ion-button (click)="toggleFilter()" [color]="!showFilter() ? 'secondar' : 'secondary'">
					@if (showFilter()) {
					<ion-icon slot="icon-only" name="filter-circle"></ion-icon>
					} @else {
					<ion-icon slot="icon-only" name="filter-circle-outline"></ion-icon>
					}
				</ion-button>
			}

			<ion-button (click)="refresh()">
				<ion-icon slot="icon-only" name="reload-circle"></ion-icon>
			</ion-button>

			@if (entityConfig.table.sortable) {
				<ion-button [routerLink]="`/sortable/${entityConfig.contentType}/title`">
					<ion-icon slot="icon-only" name="list-circle"></ion-icon>
				</ion-button>
			}

			@if (entityConfig.actions.items?.create) {
				<ion-button [routerLink]="`/${entityConfig.contentType}/create`">
					<ion-icon slot="icon-only" name="add-circle"></ion-icon>
				</ion-button>
			}
		</ion-buttons>

		@if (entityConfig.actions.items?.print || entityConfig.actions.items?.export && (entityConfig.actions.items?.exportPdf || entityConfig.actions.items?.exportExcel))
		{
			<ion-buttons slot="end">
				<ion-button (click)="presentPrintModal()">
					<ion-icon slot="icon-only" name="cloud-download"></ion-icon>
				</ion-button>
				<ion-button (click)="presentPrintModal()">
					<ion-icon slot="icon-only" name="cloud-upload"></ion-icon>
				</ion-button>
			</ion-buttons>
		}
	</ion-toolbar>


	@if (showFilter()) {
		<ion-toolbar>
			<app-table-filters [entityConfig]="entityConfig" (onSubmit)="onFilterSubmit($event)"></app-table-filters>
		</ion-toolbar>
	}
</ion-header>


<ion-content [fullscreen]="true">

	<!-- @if (showFilter()) {
		<app-table-filters [expandable]="true" [sticky]="true" [entityConfig]="entityConfig" (onSubmit)="onFilterSubmit($event)"></app-table-filters>
	} -->


	@if (bulkMode) {
		<div class="bulk-actions-toolbar">
			<ion-note>{{ 'mf-bulk-actions' | translate }}</ion-note>
			<ion-toolbar color="warning">
				<ion-buttons slot="start">
					<ion-button (click)="bulkDelete()" [disabled]="!hasSelection">
						<ion-icon slot="icon-only" name="trash-outline"></ion-icon>
					</ion-button>
					<ion-button (click)="bulkDelete()" [disabled]="!hasSelection">
						<ion-icon slot="icon-only" name="cloud-download-outline"></ion-icon>
					</ion-button>
					@if (entityConfig.actions.bulk?.custom; as customBuldActions) {
						@for (cbAction of customBuldActions; track cbAction.title) {
							<ion-button (click)="cbAction?.handler(selection.selected)" [disabled]="!hasSelection">
								<ion-icon slot="icon-only" [name]="cbAction?.icon || 'chevron-back-circle'"></ion-icon>
							</ion-button>
						}
					}
				</ion-buttons>
				<ion-buttons slot="end">
					<ion-button (click)="selection.clear()" [disabled]="!hasSelection">
						<ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
					</ion-button>
				</ion-buttons>
			</ion-toolbar>
		</div>
	}

	<div class="ion-padding">
		<div class="mat-wrapper">
			<ng-container *ngTemplateOutlet="table; context: { $implicit: dataSource, print: false }"></ng-container>
			<ng-template #table let-data let-isPrint="print">
				<table mat-table matSort [dataSource]="data" class="mat-elevation-z8">
					<ng-container *ngIf="bulkMode" matColumnDef="select">
						<th mat-header-cell *matHeaderCellDef>
						  <mat-checkbox
							(change)="masterToggle()"
							[checked]="isAllSelected()"
							[indeterminate]="selection.hasValue() && !isAllSelected()"
							[aria-label]="checkboxLabel()">
						  </mat-checkbox>
						</th>
						<td mat-cell *matCellDef="let row">
						  <mat-checkbox
							(click)="$event.stopPropagation()"
							(change)="selection.toggle(row)"
							[checked]="selection.isSelected(row)"
							[aria-label]="checkboxLabel(row)">
						  </mat-checkbox>
						</td>
					  </ng-container>
					<ng-container *ngFor="let column of entityConfig.table.columns"
						[matColumnDef]="column.columnDef || column.key">
						@if (column.sortable && !isPrinting) {
							<th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.key">
								{{ column.label | translate }}
							</th>
						} @else {
							<th mat-header-cell *matHeaderCellDef>
								{{ column.label | translate }}
							</th>
						}

						<td mat-cell *matCellDef="let item" [ngClass]="{'chip-col': column.renderType === 'chip'}">
							@switch (column.renderType) {
								@case ('chip') {
									<ion-chip [color]="item[column.key] ? 'success' : 'danger'">
										{{ item[column.key] ? (column.trueValue || '' | translate) : (column.falseValue || '' |
										translate) }}
									</ion-chip>
								}

								@case ('image') {
									<ion-img [src]="item | localize: column.key:selectedLocale()"></ion-img>
								}

								@case ('date') {
									{{ item | getValue: column | date: column.format || 'yyyy-MM-dd' }}
								}

								@case ('time') {
									{{ item | getValue: column | date: column.format || 'hh:mm' }}
								}

								@case ('object') {
									{{ column.localizable ? (item[column.key] | localize: column.localizeField) : column.localizeField }}
								}

								@default {
									{{ item | getValue: column:'':selectedLocale() }}
								}
							}
						</td>

					</ng-container>

					@if (showActions && !isPrint) {
						<ng-container matColumnDef="actions">
							<th mat-header-cell *matHeaderCellDef class="actions-col"> {{ 'mf-actions' | translate }} </th>
							<td mat-cell *matCellDef="let item">
								<ion-buttons slot="end">
									@if (entityConfig.actions.items?.delete) {
										<ion-button (click)="delete(item)" color="danger">
											<ion-icon slot="icon-only" name="trash"></ion-icon>
										</ion-button>
									}

									@if (entityConfig.actions.items?.edit) {
										<ion-button color="primary"
											[routerLink]="[`/${entityConfig.contentType}/edit`, entityConfig.table.idColumn ? item[entityConfig.table.idColumn] : item.id]">
											<ion-icon slot="icon-only" name="create"></ion-icon>
										</ion-button>
									}

									@if (entityConfig.actions.items?.view) {
										<ion-button color="primary"
											[routerLink]="[`/${entityConfig.contentType}/view`, entityConfig.table.idColumn ? item[entityConfig.table.idColumn] : item.id]">
											<ion-icon slot="icon-only" name="eye"></ion-icon>
										</ion-button>
									}

									@if (entityConfig.actions.items?.custom && entityConfig.actions.items?.custom?.length) {
										@for (cAction of entityConfig.actions.items?.custom; track cAction.title) {
											<ion-button color="primary" (click)="cAction?.handler(item)">
												<ion-icon slot="icon-only" [name]="cAction?.icon || 'chevron-back-circle'"></ion-icon>
											</ion-button>
										}
									}

									@if (entityConfig.actions.items?.more && entityConfig.actions.items?.more?.length) {

										<ion-button color="primary" button mat-button [matMenuTriggerFor]="customActions">
											<ion-icon slot="icon-only" name="ellipsis-vertical-circle-sharp"></ion-icon>
										</ion-button>
										<mat-menu #customActions="matMenu">
											@for (cAction of entityConfig.actions.items?.more; track cAction.title) {
												<button mat-menu-item (click)="cAction?.handler(item)">{{ cAction?.title ?? 'mf-action' | translate }}</button>
											}
										</mat-menu>
									}

								</ion-buttons>
							</td>
						</ng-container>
					}

					<tr mat-header-row *matHeaderRowDef="visibleColumnKeys"></tr>
					<tr mat-row *matRowDef="let row; columns: visibleColumnKeys;"></tr>

				</table>
			</ng-template>


			@if (isLoading()) {
				<div class="ion-padding flex aic jcs">
					<span>جاري التحميل...</span>
				</div>
			} @else if (!isLoading() && !dataSource.data.length) {
				<div class="ion-padding flex aic jcs">
					<span>No data</span>
				</div>
			} @else if (!isLoading() && error) {
				<div class="ion-padding flex aic jcs">
					<span>حدث خطأ ما</span>
				</div>
			}

		</div>
	</div>

</ion-content>

<ion-footer>
	@if (isLoading()) {
		<ion-progress-bar type="indeterminate"></ion-progress-bar>
	}
	<mat-paginator [length]="totalCount" [pageSizeOptions]="[20, 40, 60, 80, 100]" [pageSize]="20"
		showFirstLastButtons></mat-paginator>
</ion-footer>


<ion-loading></ion-loading>
<ion-alert #deleteAlert [header]="'mf-delete-item' | translate" [message]="'mf-delete-item-desc' | translate"
	[buttons]="[{text: 'mf-cancel' | translate, role: 'cancel'}, {text: 'mf-delete' | translate, role: 'confirm'}]"></ion-alert>

<ion-modal #printModal style="--width: 98%;--height: 97%;" (willDismiss)="onPrintModalWillDismiss($event)">
	<ng-template>
		<ion-header>
			<ion-toolbar>
				<ion-buttons slot="start">
					<ion-button (click)="closePrintModal()">
						<ion-icon slot="icon-only" name="close-circle"></ion-icon>
					</ion-button>
				</ion-buttons>
				<ion-title slot="start">{{ 'mf-print-dialog' | translate }}</ion-title>
				<ion-buttons slot="start">

					<mat-button-toggle-group
						name="printMode"
						[(ngModel)]="printMode"
						aria-label="Print Mode"
						(change)="togglePrintMode($event)"
						style="margin-inline-end: 10px;">
						<mat-button-toggle value="page">الصفحة الحالية</mat-button-toggle>
						<mat-button-toggle value="all">كل النتائج</mat-button-toggle>
					</mat-button-toggle-group>
				  	<mat-button-toggle-group
						name="fieldMode"
						[(ngModel)]="fieldMode"
						aria-label="Field Mode"
						(change)="toggleFieldMode($event)">
						<mat-button-toggle value="all">كل الحقول</mat-button-toggle>
						<mat-button-toggle value="custom">حقول مخصصة</mat-button-toggle>
					</mat-button-toggle-group>
				</ion-buttons>
				<ion-buttons slot="end">
					@if (entityConfig.actions.items?.export && (entityConfig.actions.items?.exportPdf || entityConfig.actions.items?.exportExcel))
					{
						<ion-button button mat-button [matMenuTriggerFor]="exportMenu">
							<ion-icon slot="icon-only" name="arrow-down-circle"></ion-icon>
						</ion-button>
						<mat-menu #exportMenu="matMenu">
							@if (entityConfig.actions.items?.exportPdf) {
								<button mat-menu-item (click)="export()">PDF</button>
							}

							@if (entityConfig.actions.items?.exportExcel) {
								<button mat-menu-item (click)="export('xlsx')">Excel</button>
							}
						</mat-menu>
					}

					@if (entityConfig.actions.items?.print) {
						<ion-button (click)="print()">
							<ion-icon slot="icon-only" name="print"></ion-icon>
						</ion-button>
					}
				</ion-buttons>
			</ion-toolbar>
			@if (fieldMode === 'custom') {
				<ion-toolbar>
					<div class="ion-padding field-selector">
						<mat-form-field appearance="outline" style="width: 40%">
							<mat-label>{{ 'mf-select-fields' | translate }}</mat-label>
							<mat-select [(value)]="selectedPrintFields" multiple>
							<mat-option *ngFor="let col of entityConfig.table.columns" [value]="col.key">
								{{ col.label | translate }}
							</mat-option>
							</mat-select>
						</mat-form-field>
					</div>
				</ion-toolbar>
			}
		</ion-header>
		<ion-content class="ion-padding print-content">
			<div #printSection id="print-section" class="print-area">
				@if (isPrinting) {
					<app-print [items]="printData" [entityConfig]="entityConfig" [columns]="printableColumns" />
					<!-- <ng-container *ngTemplateOutlet="table; context: { $implicit: printData, print: true }"></ng-container> -->
				}
			</div>
		</ion-content>
	</ng-template>
</ion-modal>
